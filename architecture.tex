%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Проектирование архитектуры системы}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Архитектура приложения}

Реализация веб-приложения подразумевает использование клиент-серверной архитектуры приложения. В качестве протокола прикладного уровня стандартом для веб-сайтов, де-факто, являются протоколы HTTP \cite{http} и HTTPS \cite{https}. Это обусловлено, в первую очередь, тем фактом, что данный протокол поддерживается во всех современных браузерах. Для организации веб-сервиса на основе данного протокола используются два подхода – RESTful и SOAP. Прежде чем рассмотреть конкретные технологии, используемые в разработке подобных приложений, рассмотрим данные архитектурные стили взаимодействия клиента и сервера. 

\subsection{REST}

REST (Representational State Transfer) – архитектурный стиль взаимодействия распределенных клиент-серверных приложений \cite{rest}. Термин «RESTful» применяется к веб-сервисам, работающим в соответствии с заложенными в основу данного стиля принципами. Важно отметить, что RESTful сервисы ориентированы на работу с данными. Важнейшей особенностью REST-взаимодействий является соответствие принципам CRUD (create, read, update, delete) –- использование четырёх базовых методов работы с персистентными хранилищами данных \cite{rest}. Как следствие, при построении приложений возможно использование стандартных методов протокола HTTP, что упрощает разработку и уменьшает объем передаваемого сообщения. Пример запроса и ответа в RESTful стиле приведен в листинге \ref{lst:rest}.

\begin{lstlisting}[language=Python, 
label=lst:rest, 
caption={Пример запроса и ответа в RESTful стиле.}]
/* Запрос */
GET /index.php HTTP/1.1
Host: example.com
User-Agent: Mozilla/5.0 (Linux i686; ru) Firefox/3.0b5
Accept: text/html
Connection: close

/* Ответ */
HTTP/1.0 200 OK
Server: nginx/0.6.31
Content-Language: ru
Content-Type: text/html; charset=utf-8
Content-Length: 1234
Connection: close

/* HTML page */
\end{lstlisting}

\subsection{SOAP}

SOAP - Simple Object Access Protocol, протокол обмена структурированными сообщениями в распределенном приложении. Главным преимуществом данного стиля является строгая типизация данных. Данные передаются в формате XML, пример запроса и ответа приведен в листинге \ref{lst:soap}. SOAP ориентирован на работу с операциями, т.е. с его помощью возможно построение сложного веб-сервиса \cite{soap}. 

Для передачи SOAP-сообщений наиболее часто используется протокол HTTP, но, в отличие от RESTful сервисов, не реализует принципы CRUD, т.к. все сообщения передаются с помощью HTTP-метода POST.

\begin{lstlisting}[language=Python, 
label=lst:soap, 
caption={Пример запроса и ответа в SOAP стиле.}]
/* Запрос */
<?xml version="1.0" encoding="UTF-8"?>
<env:Envelope xmlns:env="http://www.w3.org/2003/05/soap-envelope" 
xmlns:ns1="http://example.com/soap" 
xmlns:xsd="http://www.w3.org/2001/XMLSchema" 
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
xmlns:enc="http://www.w3.org/2003/05/soap-encoding">
<env:Body>
<ns1:getSmth env:encodingStyle="http://www.w3.org/2003/05/soap-encoding">
</ns1:getSmth>
</env:Body>
</env:Envelope>

/* Ответ */
<?xml version="1.0" encoding="UTF-8"?>
<env:Envelope xmlns:env="http://www.w3.org/2003/05/soap-envelope" 
xmlns:ns1="http://example.com/soap" 
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
xmlns:xsd="http://www.w3.org/2001/XMLSchema" 
xmlns:ns2="http://xml.apache.org/xml-soap" 
xmlns:enc="http://www.w3.org/2003/05/soap-encoding">
<env:Body xmlns:rpc="http://www.w3.org/2003/05/soap-rpc">
<ns1:getSmthResponse env:encodingStyle="http://www.w3.org/2003/05/soap-encoding">
<rpc:result>return</rpc:result>
<return xsi:type="ns2:Map">
<item>
<key xsi:type="xsd:string"> Something </key>
<value xsi:type="xsd:float"> 0 </value>
</item>
</ns1:getSmthResponse>
</env:Body>
</env:Envelope>
\end{lstlisting}

\subsection{Вывод}

Наиболее оптимальным решением, в соответствии с требованиями к приложению, является использование REST стиля. Проектируемое приложение в рамках клиент-серверного взаимодействия сводится к выполнению двух операций клиента и двух операций сервера:

\begin{itemize}
	\item Со стороны клиента:
	\begin{itemize}
		\item Запрос статических файлов (HTML, CSS, JavaScript);
		\item Отправка исходного кода описания верифицируемой модели;
	\end{itemize}
	\item Со стороны сервера:
	\begin{itemize}
	\item Выдача статических файлов;
	\item Отправка результата верификации описанной в запросе модели.
	\end{itemize}
\end{itemize}

Таким образом, клиентской части приложения необходимы удаленные вызовы двух методов. Очевидно, что SOAP, в данном случае, избыточен вследствие своей направленности на работу с операциями, в то время как построение REST сервиса на основе HTTP-методов GET (для запроса статики) POST (для отправки серверу описания модели) является оптимальным.

\section{Серверная часть приложения}

В рамках инструментов реализации веб-серверов представлен широкий спектр технологий. Все они имеют существенные отличия друг от друга, каждая ориентирована на определенную характеристику предоставляемых сервисов. Ниже рассмотрим основные технологии, используемые в разработке веб-серверов. 

\subsection{Java Sockets}

Сокет – программный интерфейс, представляющий собой средство межпроцессного взаимодействия в распределенном программном обеспечении. Java Sockets – реализация сокетов в языке Java. С помощью сокетов становится возможна передача данных между двумя удаленными узлами компьютерной сети. Для передачи данных используются потоки ввода/вывода, привязанные к объекту сокета, с помощью которых возможна передача как текстовых, так и бинарных данных. В качестве транспортного протокола возможно использование как TCP, так и UDP \cite{sockets}. В ходе написания веб-сервера с помощью Java Sockets необходимо решить следующие задачи:

\begin{itemize}
	\item Разбор HTTP-заголовков запроса, формирование HTTP-заголовков ответа;
	\item Параллельное обслуживание клиентов;
	\item Выдача данных статических файлов.
\end{itemize}

Статическая типизация в языке Java предоставляет больший уровень контроля исполнения кода разработчиком (по сравнению с динамически типизированными языками). Java является компилируемым в байт-код языком, что делает программы быстрее, в отличие от интерпретируемых языков.

\subsection{Node.js}

Node.js – программная платформа, предназначенная для трансляции JavaScript в машинный код, тем самым превращая его в язык общего назначения. Основан на движке V8, разработанным корпорацией Google. Разработчик node.js заложил в основу платформы принципы событийно-ориентированно и асинхронного программирования \cite{node}. Платформа предоставляет разработчику инструменты разработки сервисов параллельного обслуживания клиентов, не обременяя его реализацией механизмов синхронизации доступа к данным благодаря использованию единственного потока. Данный поток способен поддерживать большое количество параллельных соединений, что возможно вследствие использования неблокирующего ввода/вывода. Однако этот факт вводит ограничение на сложность вычислений при обработке запроса. В ходе написания веб-сервера с помощью node.js необходимо решить следующие задачи:

\begin{itemize}
	\item Выдача данных из статических файлов;
	\item Разработка механизма минимизации времени простоя запросов, необходимого вследствие времязатратной обработки.
\end{itemize}

\subsection{Django Framework}

Django – веб-фреймворк, написанный на языке Python, позволяющий разработчику создавать приложения в соответствии с архитектурным шаблоном MVC (Model-View-Controller). Данный фреймворк разрабатывался с целью минимизации временный затрат на разработку \cite{django}. Среди особенностей необходимо выделить концепцию разделения функциональности сервера на независимые Django-приложения, что предоставляет возможность переиспользования кода. В ходе написания веб-сервера с помощью Django необходимо решить следующие задачи:

\begin{itemize}
	\item Выдача статических файлов;
	\item Запуск процесса NuSMV и выдача результатов выполнения.
\end{itemize}

Для реализации RESTful сервиса в соответствии с описанными выше задачами в Django существует библиотека REST Framework, предоставляющая доступ к декораторам, упрощающим обработку запросов методов API.

\subsection{Вывод} 

В результате анализа инструментов разработки веб-серверов, наиболее оптимальным для данной задачи был выбран Django Framework. Его использование позволяет существенно сократить количество кода, что сокращает как время разработки, так и количество потенциальных ошибок. Концепция разделения функциональности на приложения, что в нашем случае позволяет разделить сервер на функциональные блоки: блок выдачи статических файлов и блок запуска процесса верификации модели. 

\section{Клиентская часть приложения}

Клиентская часть приложения представляет собой веб-страницу, при разработке которой стандартом является использование HTML (HyperText Markup Language) для разметки страницы, CSS (Cascading Style Sheets) для стилизации элементов и JavaScript для обеспечения интерактивного взаимодействия с пользователем. Наиболее интересным для рассмотрения является выбор технологий JavaScript в силу огромного количества фреймворков, библиотек и паттернов.

Клиентскую часть приложения функционально разделим на рендеринг графического интерфейса и реализацию модели и логики. Графический интерфейс, в свою очередь, разделим на две части:

\begin{itemize}
	\item Блок стандартных элементов управления;
	\item Блок построения диаграмм.
\end{itemize}

Рассмотрим технологии, предоставляющие возможность разработки вышеперечисленных элементов системы.

\subsection{Инструмент рендеринга блока стандартных элементов управления}

\subsubsection{React.js}

React -- библиотека JavaScript, предназначенная для создания пользовательских интерфейсов, разрабатываемая компанией Facebook и сообществом индивидуальных разработчиков \cite{reactjs}. Отличительной особенностью является гибкость: написанные с помощью библиотеки компоненты могут использоваться вместе с любой другой технологией. Компоненты соответствуют принципам реактивного программирования -- при любом изменении данных происходит рендеринг, что позволяет строить отзывчивые приложения. Также следует отметить высокое быстродействие, достигнутое с помощью использования виртуальной модели DOM. Также библиотека предоставляет простой механизм создания: наследование от базового класса \textit{React.Component} и переопределение необходимых методов жизненного цикла.
 
Главный метод жизненного цикла компонента, реализующий рендеринг -- \textit{Component.render()}. React предоставляет синтаксическое расширения языка JavaScript -- JSX -- с помощью которого реализуется комбинирование тегов HTML и кода JavaScript. С помощью JSX реализуется реактивное поведение компонентов. Пример JSX кода приведен в листинге.

\subsubsection{Angular}

Angular – JavaScript фреймворк, предназначенный для построения одностраничных приложений. Отличительной особенностью данной технологии является расширение стандартного HTML директивами, необходимыми для динамического изменения отображения в соответствии с данными \cite{angular}. Технология реализует паттерн MVC и использует двустороннее связывание – изменение содержимого элемента влечет изменение модели и наоборот. Пример HTML кода с Angular директивами приведен в листинге. 

\subsubsection{Vue}

Vue – библиотека JavaScript, во многом схожая с React, например:

\begin{itemize}
	\item Использование виртуального DOM \cite{vuejs};
	\item Соответствие реактивному шаблону;
	\item Компонентная структура \cite{vuejs};
	\item Реализация исключительно слоя View паттерна MVC;
\end{itemize}

Рассмотрим также отличия библиотеки Vue от React:

\begin{itemize}
	\item Использование более легковесной модели виртуального DOM;
	\item Использование шаблонов HTML и CSS вместо JSX и CSS-in-JS в React;
	\item Независимость от версии JavaScript.
\end{itemize}

\subsubsection{Вывод}

В процессе выбора технологии разработки стандартных элементов управления на первом этапе отборе был исключен Angular Framework. Несмотря на то, что он, в отличие от React и Vue, предоставляет инструменты создания как слоя View, так и Model шаблона MVC, он остается HTML-ориентированным, что ограничивает функциональные возможности по сравнению с JavaScript-ориентированными React и Vue.

При сравнении React и Vue решающим фактором был тот факт, что для React существует большое количество готовых компонентов, что открывает возможности их переиспользования и, как следствие, уменьшение времени разработки.

\subsection{Инструмент рендеринга блока построения диаграмм}

\subsubsection{Pixi.js}

Разработчики Pixi позиционируют свой продукт как «быстрый, гибкий и бесплатный движок создания HTML5 рендеров» \cite{pixijs}. Pixi позволяет создавать быстрые приложения с плавной анимацией. Библиотека работает только с 2D графикой, поддерживает высокий уровень абстракции, что позволяет разработчикам создавать приложения, не вникая в детали реализации. Рендеринг по умолчанию основан на WebGL, но, в случае, если в браузере отсутствует его поддержка, происходит автоматическое переключение на canvas. Как известно, в \textit{canvas} объекты после прорисовки становятся частью точечного полотна, что затрудняет связывание объекта с обработчиком событий, однако в Pixi реализован механизм определения объекта события.

\subsubsection{D3.js} \label{sec:d3}

D3 -- библиотека для визуализации данных. В отличие от Pixi, D3 работает с SVG элементами. Построение элементов происходит в соответствии с привязанными данными. К особенностям разработки с помощью данной библиотеки относят:

\begin{itemize}
	\item Использование выборок элементов \cite{d3js};
	\item Активное использование функторов для определения обработчиков событий и установки атрибутов элементов;
	\item «Текучий интерфейс» - использование цепочек методов, каждый следующий из которых использует возвращаемое значение предыдущего;
	\item Использование связанных множеств при создании элементов.
\end{itemize}

\subsubsection{Вывод}

В разработке блока построения диаграмм более оптимальным выбором является использование библиотеки D3. Разрабатываемое приложение ориентировано на данные, что соответствует принципам данной библиотеки, т.к. главной ее целью является построение приложений визуализации данных.  Также использование SVG позволяет изменять стиль элементов с помощью CSS, что уменьшает количество JavaScript кода.

\section{Реализация модели}

Для реализации модели, с учетом выбранного стека технологий, стандартом является соответствие паттерну «однонаправленный поток данных». Для реализации данного шаблона проектирования используется библиотека Redux, три основополагающих принципа которого:

\begin{itemize}
	\item Использование единственного источника данных, объединяющего состояние всех компонентов в один объект;
	\item Состояние является объектом, доступным только для чтения;
	\item Использование чистых функций для описания мутаций.
\end{itemize}

В Redux оперируют такими понятиями, как \textbf{действие}, \textbf{хранилище}, \textbf{редьюсер}, \textbf{представление}. Схема взаимодействия элементов потока данных выглядит следующим образом (см. рис.):

\begin{enumerate}
	\item Текущее состояние хранилища отображается в представлении;
	\item Воздействие пользователя на представление вызывает действие;
	\item Действие и текущее состояние передается редьюсеру;
	\item Редьюсер создает новое состояние системы и передает его в хранилище;
\end{enumerate}
